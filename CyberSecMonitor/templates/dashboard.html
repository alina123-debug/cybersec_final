{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">Dashboard</h2>
  <div class="badge rounded-pill bg-secondary">Today</div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-8">
    <div class="card card-dark p-3">
      <div class="d-flex justify-content-between">
        <div class="fw-semibold">Events Timeline</div>
        <div class="small text-secondary">Cases created per hour</div>
      </div>
      <canvas id="timelineChart" height="110"></canvas>
      <div class="small text-secondary mt-2">Hover a point to see cases count for that hour.</div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card card-dark p-3 h-100">
      <div class="fw-semibold mb-2">Alerts (today)</div>
      <div class="d-flex gap-3 align-items-center">
        <div class="metric">
          <div class="big" id="totalAlerts">{{ stats.total_alerts_today }}</div>
          <div class="small text-secondary">Total alerts</div>
        </div>
        <div class="ms-auto text-end">
          <div class="small text-secondary">Last scan</div>
          <div class="fw-semibold" id="lastScan">{{ stats.last_scan_seconds_ago }}s ago</div>
        </div>
      </div>
      <hr class="border-secondary">
      <div class="row g-2">
        <div class="col-6"><div class="pill">Critical <span id="pCritical">{{ stats.severity_percent.CRITICAL }}%</span></div></div>
        <div class="col-6"><div class="pill">High <span id="pHigh">{{ stats.severity_percent.HIGH }}%</span></div></div>
        <div class="col-6"><div class="pill">Medium <span id="pMedium">{{ stats.severity_percent.MEDIUM }}%</span></div></div>
        <div class="col-6"><div class="pill">Low <span id="pLow">{{ stats.severity_percent.LOW }}%</span></div></div>
      </div>
      <div class="mt-3">
        <canvas id="severityChart" height="160"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card card-dark p-3 h-100">
      <div class="fw-semibold mb-2">Threat Map</div>
      <div class="small text-secondary mb-2">Toy meaning: origin zones vs target clusters (scatter). Color is not enforced here.</div>
      <canvas id="threatChart" height="180"></canvas>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card card-dark p-3 h-100">
      <div class="fw-semibold mb-2">Type of Incidents (today)</div>
      <canvas id="incidentsChart" height="180"></canvas>
      <div class="small text-secondary mt-2">Click a label to open Cases filtered by incident type.</div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card card-dark p-3 h-100">
      <div class="fw-semibold mb-2">Quick Links</div>
      <div class="list-group list-group-flush">
        <a class="list-group-item list-group-item-dark" href="/cases/?today=1">Cases today</a>
        <a class="list-group-item list-group-item-dark" href="/alerts/?today=1">Alerts today</a>
        <a class="list-group-item list-group-item-dark" href="/reports/">Reports</a>
        <a class="list-group-item list-group-item-dark" href="/rules/">Rules</a>
      </div>
      <div class="small text-secondary mt-3">New cases/alerts trigger a push notification (WebSocket).</div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.MONITOR.initDashboard();
</script>
{% endblock %}
